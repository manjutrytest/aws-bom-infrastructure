name: Deploy BOM Infrastructure (Direct)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  AWS_REGION: eu-north-1
  AWS_ACCOUNT_ID: 588681235095

permissions:
  id-token: write
  contents: read

jobs:
  deploy-bom:
    name: Deploy BOM Infrastructure Direct
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsBOMCloudFormationRole
          role-session-name: BOM-Deploy-Direct
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS Connection
        run: |
          echo "üîê Verifying AWS connection..."
          aws sts get-caller-identity
          echo "‚úÖ AWS connection verified"
      
      - name: Parse BOM and Generate Parameters
        run: |
          echo "üîç Parsing BOM file..."
          
          # Create parameters directory
          mkdir -p parameters
          
          # Use the simple parser directly
          python scripts/simple-bom-parser.py bom/customer-bom.csv ${{ github.event.inputs.environment }}
          
          echo "üìã Generated parameter files:"
          ls -la parameters/
          
          echo "üìÑ Network parameters:"
          cat parameters/network-stack-parameters.json
          
          echo "üìÑ Compute parameters:"
          cat parameters/compute-stack-parameters.json
          
          echo "üìÑ Storage parameters:"
          cat parameters/storage-stack-parameters.json
      
      - name: Deploy Network Stack (Direct)
        run: |
          echo "üåê Deploying Network Stack using direct CloudFormation deploy..."
          
          # Use aws cloudformation deploy (no change sets)
          aws cloudformation deploy \
            --template-file cloudformation/network-stack.yaml \
            --stack-name network-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/network-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          echo "‚úÖ Network stack deployment completed"
      
      - name: Deploy Compute Stack (Direct)
        run: |
          echo "üíª Deploying Compute Stack using direct CloudFormation deploy..."
          
          # Check if stack exists and is in a failed state
          STACK_NAME="compute-stack-${{ github.event.inputs.environment }}"
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          
          echo "Current stack status: $STACK_STATUS"
          
          # Delete stack if it's in a failed state
          if [[ "$STACK_STATUS" == "ROLLBACK_COMPLETE" || "$STACK_STATUS" == "CREATE_FAILED" || "$STACK_STATUS" == "ROLLBACK_FAILED" || "$STACK_STATUS" == "UPDATE_ROLLBACK_COMPLETE" ]]; then
            echo "üóëÔ∏è Stack is in failed state ($STACK_STATUS). Deleting before redeployment..."
            aws cloudformation delete-stack --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
            echo "‚è≥ Waiting for stack deletion to complete..."
            aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
            echo "‚úÖ Failed stack deleted successfully"
          fi
          
          # Deploy the stack
          aws cloudformation deploy \
            --template-file cloudformation/compute-stack.yaml \
            --stack-name compute-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/compute-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          echo "‚úÖ Compute stack deployment completed"
      
      - name: Deploy Storage Stack (Direct)
        run: |
          echo "üóÑÔ∏è Deploying Storage Stack using direct CloudFormation deploy..."
          
          # Check if stack exists and is in a failed state
          STACK_NAME="storage-stack-${{ github.event.inputs.environment }}"
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          
          echo "Current stack status: $STACK_STATUS"
          
          # Delete stack if it's in a failed state
          if [[ "$STACK_STATUS" == "ROLLBACK_COMPLETE" || "$STACK_STATUS" == "CREATE_FAILED" || "$STACK_STATUS" == "ROLLBACK_FAILED" || "$STACK_STATUS" == "UPDATE_ROLLBACK_COMPLETE" ]]; then
            echo "üóëÔ∏è Stack is in failed state ($STACK_STATUS). Deleting before redeployment..."
            aws cloudformation delete-stack --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
            echo "‚è≥ Waiting for stack deletion to complete..."
            aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
            echo "‚úÖ Failed stack deleted successfully"
          fi
          
          # Validate template first
          echo "üîç Validating CloudFormation template..."
          aws cloudformation validate-template --template-body file://cloudformation/storage-stack.yaml --region ${{ env.AWS_REGION }}
          
          # Show parameters being used
          echo "üìã Parameters being used:"
          cat parameters/storage-stack-parameters.json
          
          # Deploy the stack
          aws cloudformation deploy \
            --template-file cloudformation/storage-stack.yaml \
            --stack-name storage-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/storage-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          # If deployment fails, show stack events
          if [ $? -ne 0 ]; then
            echo "‚ùå Deployment failed. Showing stack events:"
            aws cloudformation describe-stack-events --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} --query 'StackEvents[0:10].[Timestamp,ResourceStatus,ResourceType,LogicalResourceId,ResourceStatusReason]' --output table
          else
            echo "‚úÖ Storage stack deployment completed"
          fi
      
      - name: Show Deployment Results
        run: |
          echo "üéâ BOM Infrastructure Deployment Results"
          echo "========================================"
          
          echo "üìä CloudFormation Stacks:"
          aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query 'StackSummaries[?contains(StackName, `${{ github.event.inputs.environment }}`)].[StackName,StackStatus,CreationTime]' \
            --output table
          
          echo ""
          echo "üñ•Ô∏è EC2 Instances:"
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=BOM-Infrastructure" "Name=instance-state-name,Values=running,pending" \
            --query 'Reservations[].Instances[].{Name:Tags[?Key==`Name`].Value|[0],InstanceId:InstanceId,State:State.Name,InstanceType:InstanceType,PublicIP:PublicIpAddress}' \
            --output table || echo "No EC2 instances found"
          
          echo ""
          echo "ü™£ S3 Buckets:"
          aws s3api list-buckets \
            --query 'Buckets[?contains(Name, `bom`)].{Name:Name,CreationDate:CreationDate}' \
            --output table || echo "No BOM S3 buckets found"
          
          echo ""
          echo "‚úÖ BOM Infrastructure Deployment Complete!"
          echo "üéØ Environment: ${{ github.event.inputs.environment }}"
          echo "üåç Region: ${{ env.AWS_REGION }}"