name: Deploy BOM Infrastructure (Direct)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  AWS_REGION: eu-north-1
  AWS_ACCOUNT_ID: 588681235095

permissions:
  id-token: write
  contents: read

jobs:
  deploy-bom:
    name: Deploy BOM Infrastructure Direct
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsBOMCloudFormationRole
          role-session-name: BOM-Deploy-Direct
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS Connection
        run: |
          echo "ğŸ” Verifying AWS connection..."
          aws sts get-caller-identity
          echo "âœ… AWS connection verified"
      
      - name: Parse BOM and Generate Parameters
        run: |
          echo "ğŸ” Parsing BOM file..."
          
          # Create parameters directory
          mkdir -p parameters
          
          # Use the simple parser directly
          python scripts/simple-bom-parser.py bom/customer-bom.csv ${{ github.event.inputs.environment }}
          
          echo "ğŸ“‹ Generated parameter files:"
          ls -la parameters/
          
          echo "ğŸ“„ Network parameters:"
          cat parameters/network-stack-parameters.json
          
          echo "ğŸ“„ Compute parameters:"
          cat parameters/compute-stack-parameters.json
          
          echo "ğŸ“„ Storage parameters:"
          cat parameters/storage-stack-parameters.json
      
      - name: Deploy Network Stack (Direct)
        run: |
          echo "ğŸŒ Deploying Network Stack using direct CloudFormation deploy..."
          
          # Use aws cloudformation deploy (no change sets)
          aws cloudformation deploy \
            --template-file cloudformation/network-stack.yaml \
            --stack-name network-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/network-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          echo "âœ… Network stack deployment completed"
      
      - name: Deploy Compute Stack (Direct)
        run: |
          echo "ğŸ’» Deploying Compute Stack using direct CloudFormation deploy..."
          
          # Use aws cloudformation deploy (no change sets)
          aws cloudformation deploy \
            --template-file cloudformation/compute-stack.yaml \
            --stack-name compute-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/compute-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          echo "âœ… Compute stack deployment completed"
      
      - name: Deploy Storage Stack (Direct)
        run: |
          echo "ğŸ—„ï¸ Deploying Storage Stack using direct CloudFormation deploy..."
          
          # Use aws cloudformation deploy (no change sets)
          aws cloudformation deploy \
            --template-file cloudformation/storage-stack.yaml \
            --stack-name storage-stack-${{ github.event.inputs.environment }} \
            --parameter-overrides file://parameters/storage-stack-parameters.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --tags Key=Project,Value=BOM-Infrastructure Key=Environment,Value=${{ github.event.inputs.environment }} \
            --no-fail-on-empty-changeset
          
          echo "âœ… Storage stack deployment completed"
      
      - name: Show Deployment Results
        run: |
          echo "ğŸ‰ BOM Infrastructure Deployment Results"
          echo "========================================"
          
          echo "ğŸ“Š CloudFormation Stacks:"
          aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query 'StackSummaries[?contains(StackName, `${{ github.event.inputs.environment }}`)].[StackName,StackStatus,CreationTime]' \
            --output table
          
          echo ""
          echo "ğŸ–¥ï¸ EC2 Instances:"
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=BOM-Infrastructure" "Name=instance-state-name,Values=running,pending" \
            --query 'Reservations[].Instances[].{Name:Tags[?Key==`Name`].Value|[0],InstanceId:InstanceId,State:State.Name,InstanceType:InstanceType,PublicIP:PublicIpAddress}' \
            --output table || echo "No EC2 instances found"
          
          echo ""
          echo "ğŸª£ S3 Buckets:"
          aws s3api list-buckets \
            --query 'Buckets[?contains(Name, `bom`)].{Name:Name,CreationDate:CreationDate}' \
            --output table || echo "No BOM S3 buckets found"
          
          echo ""
          echo "âœ… BOM Infrastructure Deployment Complete!"
          echo "ğŸ¯ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸŒ Region: ${{ env.AWS_REGION }}"