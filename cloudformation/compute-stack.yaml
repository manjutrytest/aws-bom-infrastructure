AWSTemplateFormatVersion: '2010-09-09'
Description: 'Simple Compute Stack for BOM Infrastructure'

Parameters:
  Environment:
    Type: String
    Default: development
  
  NetworkStackName:
    Type: String
    Default: network-stack
  
  CreateInstance1:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
  
  InstanceType1:
    Type: String
    Default: t3.medium
  
  VolumeSize1:
    Type: Number
    Default: 40
  
  CreateInstance2:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
  
  InstanceType2:
    Type: String
    Default: t3.medium
  
  VolumeSize2:
    Type: Number
    Default: 40
  
  CreateInstance3:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
  
  InstanceType3:
    Type: String
    Default: t3.medium
  
  VolumeSize3:
    Type: Number
    Default: 40
  
  KeyPairName:
    Type: String
    Default: ''

Conditions:
  CreateInst1: !Equals [!Ref CreateInstance1, 'true']
  CreateInst2: !Equals [!Ref CreateInstance2, 'true']
  CreateInst3: !Equals [!Ref CreateInstance3, 'true']
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Mappings:
  RegionMap:
    eu-north-1:
      AMI: ami-0014ce3e52359afbd

Resources:
  # Security Group
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for web servers
      VpcId:
        Fn::ImportValue: !Sub '${Environment}-VpcId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-web-sg'

  # Instance 1
  WebServer1:
    Type: AWS::EC2::Instance
    Condition: CreateInst1
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType1
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      SubnetId:
        Fn::ImportValue: !Sub '${Environment}-PublicSubnet1aId'
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref VolumeSize1
            VolumeType: gp3
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>BOM Web Server 1 - ${Environment}</h1>" > /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-web-server-1'
        - Key: Project
          Value: BOMInfrastructure

  # Instance 2
  WebServer2:
    Type: AWS::EC2::Instance
    Condition: CreateInst2
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType2
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      SubnetId:
        Fn::ImportValue: !Sub '${Environment}-PublicSubnet1bId'
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref VolumeSize2
            VolumeType: gp3
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>BOM Web Server 2 - ${Environment}</h1>" > /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-web-server-2'
        - Key: Project
          Value: BOMInfrastructure

  # Instance 3 (Private Subnet)
  WebServer3:
    Type: AWS::EC2::Instance
    Condition: CreateInst3
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType3
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      SubnetId:
        Fn::ImportValue: !Sub '${Environment}-PrivateSubnet1aId'
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref VolumeSize3
            VolumeType: gp3
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>BOM Web Server 3 (Private) - ${Environment}</h1>" > /var/www/html/index.html
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-web-server-3'
        - Key: Project
          Value: BOMInfrastructure

Outputs:
  WebServer1Id:
    Description: Web Server 1 Instance ID
    Value: !If [CreateInst1, !Ref WebServer1, 'Not Created']
  
  WebServer1IP:
    Description: Web Server 1 Public IP
    Value: !If [CreateInst1, !GetAtt WebServer1.PublicIp, 'Not Created']
  
  WebServer2Id:
    Description: Web Server 2 Instance ID
    Value: !If [CreateInst2, !Ref WebServer2, 'Not Created']
  
  WebServer2IP:
    Description: Web Server 2 Public IP
    Value: !If [CreateInst2, !GetAtt WebServer2.PublicIp, 'Not Created']
  
  WebServer3Id:
    Description: Web Server 3 Instance ID (Private)
    Value: !If [CreateInst3, !Ref WebServer3, 'Not Created']
  
  WebServer3IP:
    Description: Web Server 3 Private IP
    Value: !If [CreateInst3, !GetAtt WebServer3.PrivateIp, 'Not Created']